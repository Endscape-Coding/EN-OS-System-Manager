<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EN-OS System Manager</title>
    <link rel="stylesheet" href="style.css">
    <style id="dynamic-styles"></style>
</head>
<body>

    <button class="icon-btn settings-trigger" id="settingsBtn" aria-label="Settings">
        <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
    </button>

    <main class="container">
        <header class="app-header">
            <h1 data-key="app_title">EN-OS System Manager</h1>
            <p class="subtitle">GUI Settings for EN-OS</p>
        </header>

        <div class="main-layout">
            <div class="grid-menu">
                <button onclick="runProgram('driver')" class="card-btn">
                    <span class="btn-icon">üîß</span>
                    <div class="btn-content">
                        <span class="btn-title" data-key="driver_manager">Driver Manager</span>
                        <span class="btn-desc">Install GPU drivers</span>
                    </div>
                </button>

                <button onclick="runProgram('pamac')" class="card-btn">
                    <span class="btn-icon">üì¶</span>
                    <div class="btn-content">
                        <span class="btn-title" data-key="package_manager">Package Manager</span>
                        <span class="btn-desc">Install any software</span>
                    </div>
                </button>

                <button onclick="runProgram('rassist')" class="card-btn">
                    <span class="btn-icon">üñ•Ô∏è</span>
                    <div class="btn-content">
                        <span class="btn-title" data-key="remote_assistant">Remote Assistant</span>
                        <span class="btn-desc">Create Your Telegram bot</span>
                    </div>
                </button>

                <button onclick="runProgram('zapret')" class="card-btn">
                    <span class="btn-icon">üîí</span>
                    <div class="btn-content">
                        <span class="btn-title" data-key="zapret_manager">Zapret Manager</span>
                        <span class="btn-desc">Free Internet for Russia</span>
                    </div>
                </button>
            </div>

            <div class="grid-menu">
                </div>

            <div class="tweaker-footer">
                <button onclick="toggleTweaker()" class="mini-simple-btn">
                    <span style="font-size: 1.1rem; opacity: 0.7;">‚ö°</span>
                    <span data-key="mini_tweaker" style="font-size: 0.85rem; opacity: 0.8;">Mini Tweaker</span>
                </button>
            </div>
        </div>
    </main>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <div class="tweaker-modal" id="tweakerModal">
        <div class="drawer-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 data-key="mini_tweaker" style="margin:0; font-size: 1.3rem; color: var(--accent-cyan);">Mini Tweaker</h2>
            <button class="icon-btn" onclick="toggleTweaker()">‚úï</button>
        </div>

        <div class="tweak-list">
            <label class="tweak-card">
                <span class="tweak-title" data-key="zram_control">ZRAM Manager</span>
                <input type="checkbox" id="check-zram" onchange="callTweak(this.checked ? 'zram_on' : 'zram_off')">
                <div class="switch-ui"></div>
            </label>

            <label class="tweak-card">
                <span class="tweak-title" data-key="pacman_keys">Pacman Key Manager</span>
                <input type="checkbox" id="check-keys" onchange="callTweak(this.checked ? 'keys_on' : 'keys_off')">
                <div class="switch-ui"></div>
            </label>

            <div class="tweak-card action-card" onclick="callTweak('refresh_mirrors')">
                <span class="tweak-title" data-key="refresh_mirrors">Refresh Mirrors</span>
                <span class="arrow-icon">‚ûî</span>
            </div>

            <div class="tweak-card action-card" onclick="callTweak('clear_journal')">
                <span class="tweak-title" data-key="clear_journal">Clear Journal (2w)</span>
                <span class="arrow-icon">‚ûî</span>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAll()"></div>

    <aside class="settings-drawer" id="settingsPanel">
        <div class="drawer-header">
            <h2 data-key="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="icon-btn close-btn" onclick="toggleSettings()">‚úï</button>
        </div>

        <div class="drawer-content">
            <div class="setting-group">
                <label data-key="theme">–¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</label>
                <div class="theme-grid" id="themeList">
                    <button class="theme-chip active" onclick="changeTheme('default')" data-theme="default">
                        Default
                    </button>
                    </div>
            </div>

            <div class="setting-group">
                <label data-key="language">–Ø–∑—ã–∫</label>
                <select id="languageSelect" class="styled-select">
                    <option value="en">English</option>
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                    <option value="es">Espa√±ol</option>
                    <option value="de">Deutsch</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="zh">‰∏≠Êñá</option>
                    <option value="ja">Êó•Êú¨Ë™û</option>
                    <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                    <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
                </select>
            </div>

            <div class="setting-group developers-section">
            <label data-key="developer">Developer: Endscape</label>
            <div class="developer-links">
                <div onclick="openExternal('https://github.com/Endscape-Coding/')" class="dev-link">
                    <span class="dev-icon">üì¶</span>
                    <span>GitHub</span>
                </div>
                <div onclick="openExternal('https://t.me/Linux_EN_OS')" class="dev-link">
                    <span class="dev-icon">üí¨</span>
                    <span>Telegram</span>
                </div>
            </div>

            <div class="setting-info">
                <span>EN-OS System Manager v 1.1</span>
                <span class="path-hint">Config path: ~/.config/enos_manager/</span>
            </div>
        </div>
    </aside>

    <script>
        const translations = {
            en: {
                app_title: "EN-OS System Manager", settings: "Settings", theme: "Theme", language: "Language",
                developer: "Developer - Endscape", driver_manager: "Driver Manager", package_manager: "Package Manager",
                remote_assistant: "Remote Assistant", zapret_manager: "Zapret Manager",
                mini_tweaker: "Mini Tweaker",
                pacman_keys: "Automatic Pacman Key Initialization",
                zram_control: "ZRAM Manager",
                refresh_mirrors: "Refresh Mirrors",
                clear_journal: "Clear Journal (2w)",
                run: "Run"
            },
            ru: {
                app_title: "EN-OS System Manager", settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", theme: "–¢–µ–º–∞", language: "–Ø–∑—ã–∫",
                developer: "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ - Endscape", driver_manager: "–ú–µ–Ω–µ–¥–∂–µ—Ä –¥—Ä–∞–π–≤–µ—Ä–æ–≤", package_manager: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤",
                remote_assistant: "–£–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫", zapret_manager: "Zapret",
                mini_tweaker: "–ú–∏–Ω–∏-—Ç–≤–∏–∫–µ—Ä",
                pacman_keys: "–ê–≤—Ç–æ-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª—é—á–µ–π Pacman",
                zram_control: "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ZRAM",
                refresh_mirrors: "–û–±–Ω–æ–≤–∏—Ç—å –∑–µ—Ä–∫–∞–ª–∞",
                clear_journal: "–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏ (2–Ω)",
                run: "–ó–∞–ø—É—Å–∫"
            },
            uk: {
                app_title: "EN-OS System Manager", settings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è", theme: "–¢–µ–º–∞", language: "–ú–æ–≤–∞",
                developer: "–†–æ–∑—Ä–æ–±–Ω–∏–∫ - Endscape", driver_manager: "–î—Ä–∞–π–≤–µ—Ä–∏", package_manager: "–ü–∞–∫–µ—Ç–∏",
                remote_assistant: "–ü–æ–º—ñ—á–Ω–∏–∫", zapret_manager: "Zapret",
                mini_tweaker: "–ú—ñ–Ω—ñ-—Ç–≤—ñ–∫–µ—Ä",
                pacman_keys: "–ê–≤—Ç–æ-—ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–ª—é—á—ñ–≤ Pacman",
                zram_control: "–ö–µ—Ä—É–≤–∞–Ω–Ω—è ZRAM",
                refresh_mirrors: "–û–Ω–æ–≤–∏—Ç–∏ –¥–∑–µ—Ä–∫–∞–ª–∞",
                clear_journal: "–û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥–∏ (2—Ç)",
                run: "–ó–∞–ø—É—Å–∫"
            },
            es: {
                app_title: "EN-OS System Manager", settings: "Configuraci√≥n", theme: "Tema", language: "Idioma",
                developer: "Desarrollador - Endscape", driver_manager: "Controladores", package_manager: "Paquetes",
                remote_assistant: "Asistencia", zapret_manager: "Zapret",
                mini_tweaker: "Mini Tweaker",
                pacman_keys: "Inicializaci√≥n autom√°tica de llaves Pacman",
                zram_control: "Gesti√≥n ZRAM",
                refresh_mirrors: "Actualizar espejos",
                clear_journal: "Limpiar registros",
                run: "Ejecutar"
            },
            de: {
                app_title: "EN-OS System Manager", settings: "Einstellungen", theme: "Design", language: "Sprache",
                developer: "Entwickler - Endscape", driver_manager: "Treiber", package_manager: "Pakete",
                remote_assistant: "Fernwartung", zapret_manager: "Zapret",
                mini_tweaker: "Mini Tweaker",
                pacman_keys: "Automatische Pacman-Schl√ºsselinitialisierung",
                zram_control: "ZRAM verwalten",
                refresh_mirrors: "Spiegel aktualisieren",
                clear_journal: "Logs l√∂schen",
                run: "Start"
            },
            fr: {
                app_title: "EN-OS System Manager", settings: "Param√®tres", theme: "Th√®me", language: "Langue",
                developer: "D√©veloppeur - Endscape", driver_manager: "Pilotes", package_manager: "Paquets",
                remote_assistant: "Assistance", zapret_manager: "Zapret",
                mini_tweaker: "Mini Tweaker",
                pacman_keys: "Initialisation automatique des cl√©s Pacman",
                zram_control: "Gestion ZRAM",
                refresh_mirrors: "Mettre √† jour miroirs",
                clear_journal: "Vider les logs",
                run: "Lancer"
            },
            zh: {
                app_title: "EN-OS System Manager", settings: "ËÆæÁΩÆ", theme: "‰∏ªÈ¢ò", language: "ËØ≠Ë®Ä",
                developer: "ÂºÄÂèëËÄÖ - Endscape", driver_manager: "È©±Âä®ÁÆ°ÁêÜ", package_manager: "ËΩØ‰ª∂ÁÆ°ÁêÜ",
                remote_assistant: "ËøúÁ®ãÂçèÂä©", zapret_manager: "Zapret ÁÆ°ÁêÜ",
                mini_tweaker: "Ëø∑‰Ω†‰ºòÂåñÂô®",
                pacman_keys: "Pacman ÂØÜÈí•Ëá™Âä®ÂàùÂßãÂåñ",
                zram_control: "ZRAM ÁÆ°ÁêÜ",
                refresh_mirrors: "Âà∑Êñ∞ÈïúÂÉèÊ∫ê",
                clear_journal: "Ê∏ÖÁêÜÊó•Âøó",
                run: "ËøêË°å"
            },
            ja: {
                app_title: "EN-OS System Manager", settings: "Ë®≠ÂÆö", theme: "„ÉÜ„Éº„Éû", language: "Ë®ÄË™û",
                developer: "ÈñãÁô∫ËÄÖ - Endscape", driver_manager: "„Éâ„É©„Ç§„Éê„Éº", package_manager: "„Éë„ÉÉ„Ç±„Éº„Ç∏",
                remote_assistant: "„É™„É¢„Éº„Éà", zapret_manager: "Zapret",
                mini_tweaker: "„Éü„Éã„Éª„ÉÑ„Ç§„Éº„Ç´„Éº",
                pacman_keys: "Pacman„Ç≠„Éº„ÅÆËá™ÂãïÂàùÊúüÂåñ",
                zram_control: "ZRAMÁÆ°ÁêÜ",
                refresh_mirrors: "„Éü„É©„Éº„ÅÆÊõ¥Êñ∞",
                clear_journal: "„É≠„Ç∞„ÅÆÂâäÈô§",
                run: "ÂÆüË°å"
            },
            ko: {
                app_title: "EN-OS System Manager", settings: "ÏÑ§Ï†ï", theme: "ÌÖåÎßà", language: "Ïñ∏Ïñ¥",
                developer: "Í∞úÎ∞úÏûê - Endscape", driver_manager: "ÎìúÎùºÏù¥Î≤Ñ", package_manager: "Ìå®ÌÇ§ÏßÄ",
                remote_assistant: "ÏõêÍ≤© ÏßÄÏõê", zapret_manager: "Zapret",
                mini_tweaker: "ÎØ∏Îãà Ìä∏ÏúÑÏª§",
                pacman_keys: "Pacman ÌÇ§ ÏûêÎèô Ï¥àÍ∏∞Ìôî",
                zram_control: "ZRAM Í¥ÄÎ¶¨",
                refresh_mirrors: "ÎØ∏Îü¨ ÏóÖÎç∞Ïù¥Ìä∏",
                clear_journal: "Î°úÍ∑∏ Ï†ïÎ¶¨",
                run: "Ïã§Ìñâ"
            },
            hi: {
                app_title: "EN-OS ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ï", settings: "‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏", theme: "‡§•‡•Ä‡§Æ", language: "‡§≠‡§æ‡§∑‡§æ",
                developer: "‡§°‡•á‡§µ‡§≤‡§™‡§∞ - Endscape", driver_manager: "‡§°‡•ç‡§∞‡§æ‡§á‡§µ‡§∞", package_manager: "‡§™‡•à‡§ï‡•á‡§ú",
                remote_assistant: "‡§∞‡§ø‡§Æ‡•ã‡§ü", zapret_manager: "‡§ú‡§º‡•à‡§™‡•ç‡§∞‡•á‡§ü",
                mini_tweaker: "‡§Æ‡§ø‡§®‡•Ä ‡§ü‡•ç‡§µ‡•Ä‡§ï‡§∞",
                pacman_keys: "‡§™‡•à‡§ï‡§Æ‡•à‡§® ‡§ï‡•Å‡§Ç‡§ú‡•Ä ‡§∏‡•ç‡§µ‡§ö‡§æ‡§≤‡§ø‡§§ ‡§Ü‡§∞‡§Ç‡§≠‡•Ä‡§ï‡§∞‡§£",
                zram_control: "ZRAM ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§®",
                refresh_mirrors: "‡§Æ‡§ø‡§∞ÿ± ‡§Ö‡§™‡§°‡•á‡§ü",
                clear_journal: "‡§≤‡•â‡§ó ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç",
                run: "‡§ö‡§≤‡§æ‡§è‡§Ç"
            }
        };

        let currentLang = 'en';

        document.addEventListener('DOMContentLoaded', async () => {
            const settingsBtn = document.getElementById('settingsBtn');
            const langSelect = document.getElementById('languageSelect');

            settingsBtn.addEventListener('click', toggleSettings);
            langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

            if (window.__TAURI__) {
                await loadTheme();
                await loadCustomThemes();
                await loadLanguage();
            } else {
                applyTranslations('ru');
            }
        });

        function toggleSettings() {
            document.body.classList.toggle('settings-open');
        }

        async function toggleTweaker() {
            const modal = document.getElementById('tweakerModal');
            const overlay = document.getElementById('overlay');

            // –ï—Å–ª–∏ –º—ã –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã
            if (!modal.classList.contains('active')) {
                await syncTweakStatuses();
            }

            modal.classList.toggle('active');
            overlay.classList.toggle('visible');
        }

        async function syncTweakStatuses() {
            if (!window.__TAURI__) return;

            try {
                // –û–ø—Ä–∞—à–∏–≤–∞–µ–º Rust –ø–æ –∫–∞–∂–¥–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É
                const zramActive = await window.__TAURI__.core.invoke('check_prog', { name: 'zram-manager' });
                const keysActive = await window.__TAURI__.core.invoke('check_prog', { name: 'pacman-key-manager' });

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –±–µ–∑ –≤—ã–∑–æ–≤–∞ callTweak (—á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ)
                document.getElementById('check-zram').checked = zramActive;
                document.getElementById('check-keys').checked = keysActive;
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤:", e);
            }
        }

        function closeAll() {
            document.body.classList.remove('settings-open');
            document.getElementById('tweakerModal').classList.remove('active');
            document.getElementById('overlay').classList.remove('visible');
        }

        async function runProgram(mode) {
            if (!window.__TAURI__) {
                console.log(`[DEV] Run program: ${mode}`);
                showToast(`Development mode: ${mode} clicked`);
                return;
            }
            try {
                const res = await window.__TAURI__.core.invoke('startprog', { mode });
                if(res !== 'OK') showToast(`Error: ${res}`, true);
            } catch (e) {
                showToast('Launch failed', true);
            }
        }

        async function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if (translations[lang]?.[key]) el.textContent = translations[lang][key];
            });

            if (window.__TAURI__) {
                await window.__TAURI__.core.invoke('set_lang', { lang });
            }
        }

        async function loadLanguage() {
            try {
                const lang = await window.__TAURI__.core.invoke('curr_lang');
                if (lang) {
                    document.getElementById('languageSelect').value = lang;
                    setLanguage(lang);
                }
            } catch (e) { console.error(e); }
        }

        // –¢–µ–º—ã
        async function changeTheme(name) {
            if (!window.__TAURI__) {
                document.querySelectorAll('.theme-chip').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                return;
            }

            try {
                await window.__TAURI__.core.invoke('set_theme', { name });
                await loadTheme();

                document.querySelectorAll('.theme-chip').forEach(b => b.classList.toggle('active', b.dataset.theme === name));
            } catch (e) { showToast('Theme error', true); }
        }

        async function loadTheme() {
             try {
                const config = await window.__TAURI__.core.invoke('config_read');
                let css = '';
                const home = await window.__TAURI__.core.invoke('get_home_dir');
                const path = config.theme === 'default'
                    ? `${home}/.config/enos_manager/default.css`
                    : `${home}/.config/enos_manager/${config.theme}`;

                try {
                    css = await window.__TAURI__.core.invoke('theme_path', { path });
                } catch {
                    css = '';
                }
                document.getElementById('dynamic-styles').textContent = css;

                // Highlight active
                const activeBtn = document.querySelector(`.theme-chip[data-theme="${config.theme}"]`);
                if(activeBtn) {
                     document.querySelectorAll('.theme-chip').forEach(b => b.classList.remove('active'));
                     activeBtn.classList.add('active');
                }

            } catch (e) { console.error(e); }
        }

        async function loadCustomThemes() {
            try {
                const themes = await window.__TAURI__.core.invoke('custom_theme_path');
                const list = document.getElementById('themeList');
                const def = list.firstElementChild;
                list.innerHTML = '';
                list.appendChild(def);

                themes.forEach(t => {
                    if (t === 'default.css') return;
                    const btn = document.createElement('button');
                    btn.className = 'theme-chip';
                    btn.dataset.theme = t;
                    btn.textContent = t.replace('.css', '');
                    btn.onclick = (e) => changeTheme(t);
                    list.appendChild(btn);
                });
            } catch (e) { console.error(e); }
        }

        async function openExternal(link) {
            await window.__TAURI__.core.invoke('startlink', { link });
        }

        async function callTweak(name) {
            if (!window.__TAURI__) {
                showToast(`Dev Mode: Tweak ${name} called`);
                return;
            }
            try {
                const res = await window.__TAURI__.core.invoke('tweak', { name });
                showToast("Success");
            } catch (e) {
                showToast(e, true);
            }
        }

        function showToast(msg, isError = false) {
            const t = document.createElement('div');
            t.className = `toast ${isError ? 'error' : ''}`;
            t.textContent = msg;
            document.body.appendChild(t);
            requestAnimationFrame(() => t.classList.add('visible'));
            setTimeout(() => {
                t.classList.remove('visible');
                setTimeout(() => t.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
